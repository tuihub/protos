syntax = "proto3";

package librarian.sephirah.v1;

import "google/protobuf/timestamp.proto";
import "librarian/sephirah/v1/binah.proto";
import "librarian/sephirah/v1/chesed.proto";
import "librarian/sephirah/v1/gebura.proto";
import "librarian/sephirah/v1/netzach.proto";
import "librarian/sephirah/v1/tiphereth.proto";
import "librarian/sephirah/v1/yesod.proto";

option csharp_namespace = "TuiHub.Protos.Librarian.Sephirah.V1";
option go_package = "github.com/tuihub/protos/pkg/librarian/sephirah/v1;v1";

/*
 * Sephirah contains the core logic and currently divided into the following modules:
 * 1. `Tiphereth` handles account data and provides permission verification
 * 2. `Gebura` handles application data
 * 3. `Binah` handles file transfer
 * 4. `Yesod` handles feed data
 * 5. `Netzach` handles notifications
 */
service LibrarianSephirahService {
  // Allow anonymous call, use accessToken to get complete information
  rpc GetServerInformation(GetServerInformationRequest) returns (GetServerInformationResponse);
  // `Tiphereth` `Normal` Login via password and get two token
  rpc GetToken(GetTokenRequest) returns (GetTokenResponse);
  // `Tiphereth` `Normal` `Sentinel` `Porter` Use valid refresh_token and get two new token, a refresh_token can only be used once
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);
  // `Tiphereth` `Porter` Get access_token of another user with allowed privilege
  rpc GainUserPrivilege(GainUserPrivilegeRequest) returns (GainUserPrivilegeResponse);

  // `Tiphereth` `Normal` Client should register device after the first login
  // and store the device_id locally.
  // The server could add extra limits to non-registered device
  rpc RegisterDevice(RegisterDeviceRequest) returns (RegisterDeviceResponse);
  // `Tiphereth` `Normal`
  rpc ListUserSessions(ListUserSessionsRequest) returns (ListUserSessionsResponse);
  // `Tiphereth` `Normal` delete session will revoke refresh_token immediately.
  // NOTE: This can also be used to logout on server side.
  rpc DeleteUserSession(DeleteUserSessionRequest) returns (DeleteUserSessionResponse);

  // `Tiphereth` `Admin` `Normal limited`
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);
  // `Tiphereth` `Admin` `Normal limited`
  rpc UpdateUser(UpdateUserRequest) returns (UpdateUserResponse);
  // `Tiphereth` `Admin` `Normal limited`
  rpc GetUser(GetUserRequest) returns (GetUserResponse);
  // `Tiphereth` `Admin` `Normal limited`
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);

  // `Tiphereth` `Normal` Bind third-party account to current user.
  // Create (account)<-[Equal]->(current user)
  rpc LinkAccount(LinkAccountRequest) returns (LinkAccountResponse);
  // `Tiphereth` `Normal` Unbind third-party account from current user.
  // Delete (account)<-[Equal]->(current user)
  rpc UnLinkAccount(UnLinkAccountRequest) returns (UnLinkAccountResponse);
  // `Tiphereth` `Normal` List third-party account binded to current user.
  // Match ()<-[Equal]->(current user)
  rpc ListLinkAccounts(ListLinkAccountsRequest) returns (ListLinkAccountsResponse);

  // `Tiphereth` `Normal`
  rpc ListPorters(ListPortersRequest) returns (ListPortersResponse);
  // `Tiphereth` `Admin`
  rpc UpdatePorterStatus(UpdatePorterStatusRequest) returns (UpdatePorterStatusResponse);
  // `Tiphereth` `Normal only` Set porter privilege, default none privilege.
  rpc UpdatePorterPrivilege(UpdatePorterPrivilegeRequest) returns (UpdatePorterPrivilegeResponse);

  // `Binah` `upload_token`
  rpc UploadFile(stream UploadFileRequest) returns (stream UploadFileResponse);
  // `Binah` `download_token`
  rpc DownloadFile(stream DownloadFileRequest) returns (stream DownloadFileResponse);
  // `Binah` `upload_token`
  // Maximum 256M
  // Server must send response at least once a minute to keepalive.
  // Client should ignore in_process response and wait for success or error response.
  rpc SimpleUploadFile(stream SimpleUploadFileRequest) returns (stream SimpleUploadFileResponse);
  // `Binah` `download_token`
  // Server will not check the receiving state
  rpc SimpleDownloadFile(SimpleDownloadFileRequest) returns (stream SimpleDownloadFileResponse);
  // `Binah` `upload_token`
  // Upload file through http url
  rpc PresignedUploadFile(PresignedUploadFileRequest) returns (PresignedUploadFileResponse);
  // `Binah` `upload_token`
  // Report file transfer status. Mainly used to trigger server post-process immediately
  rpc PresignedUploadFileStatus(PresignedUploadFileStatusRequest) returns (PresignedUploadFileStatusResponse);
  // `Binah` `download_token`
  // Download file through http url
  rpc PresignedDownloadFile(PresignedDownloadFileRequest) returns (PresignedDownloadFileResponse);

  // `Chesed` `Normal`
  rpc UploadImage(UploadImageRequest) returns (UploadImageResponse);
  // `Chesed` `Normal`
  rpc UpdateImage(UpdateImageRequest) returns (UpdateImageResponse);
  // `Chesed` `Normal`
  rpc ListImages(ListImagesRequest) returns (ListImagesResponse);
  // `Chesed` `Normal`
  rpc SearchImages(SearchImagesRequest) returns (SearchImagesResponse);
  // `Chesed` `Normal`
  rpc GetImage(GetImageRequest) returns (GetImageResponse);
  // `Chesed` `Normal`
  rpc DownloadImage(DownloadImageRequest) returns (DownloadImageResponse);

  // `Gebura` `Admin`
  rpc CreateApp(CreateAppRequest) returns (CreateAppResponse);
  // `Gebura` `Admin`
  rpc UpdateApp(UpdateAppRequest) returns (UpdateAppResponse);
  // `Gebura` `Admin` Used to manage apps
  rpc ListApps(ListAppsRequest) returns (ListAppsResponse);
  // `Gebura` `Admin` Merge two apps
  rpc MergeApps(MergeAppsRequest) returns (MergeAppsResponse);
  // `Gebura` `Admin` Pick one app out from merged
  rpc PickApp(PickAppRequest) returns (PickAppResponse);

  // `Gebura` `Normal` Asynchronous update apps.
  // Request on INTERNAL app applies to all bound external apps.
  // Create an INTERNAL app when requested external app does not exist
  // Server should implement a sync rate limit to prevent abuse,
  // when rate limit reached, return without real sync.
  rpc SyncApps(SyncAppsRequest) returns (SyncAppsResponse);
  // `Gebura` `Normal` Asynchronously update apps associated with an account.
  // Create an INTERNAL app when associated external app does not exist.
  // Server should implement a sync rate limit to prevent abuse,
  // when rate limit reached, return without real sync.
  rpc SyncAccountApps(SyncAccountAppsRequest) returns (SyncAccountAppsResponse);
  // `Gebura` `Normal`
  rpc SearchApps(SearchAppsRequest) returns (SearchAppsResponse);
  // `Gebura` `Normal` Flattened app info, data priority is 1.INTERNAL, 2.STEAM.
  // e.g. `id` will always from INTERNAL, `description` may from STEAM if it is empty in INTERNAL
  rpc GetApp(GetAppRequest) returns (GetAppResponse);
  // `Gebura` `Normal` Original bound apps info of required app
  rpc GetBoundApps(GetBoundAppsRequest) returns (GetBoundAppsResponse);
  // `Gebura` `Normal`
  rpc PurchaseApp(PurchaseAppRequest) returns (PurchaseAppResponse);
  // `Gebura` `Normal`
  // Default get user purchased apps
  // Use `source` to get purchase info from bound account
  // only support steam
  rpc GetPurchasedApps(GetPurchasedAppsRequest) returns (GetPurchasedAppsResponse);

  // `Gebura` `Normal`
  rpc CreateAppPackage(CreateAppPackageRequest) returns (CreateAppPackageResponse);
  // `Gebura` `Normal`
  rpc UpdateAppPackage(UpdateAppPackageRequest) returns (UpdateAppPackageResponse);
  // `Gebura` `Normal`
  rpc ListAppPackages(ListAppPackagesRequest) returns (ListAppPackagesResponse);
  // `Gebura` `Normal`
  rpc AssignAppPackage(AssignAppPackageRequest) returns (AssignAppPackageResponse);
  // `Gebura` `Normal`
  rpc UnAssignAppPackage(UnAssignAppPackageRequest) returns (UnAssignAppPackageResponse);
  // `Gebura` `Sentinel`
  rpc ReportAppPackages(stream ReportAppPackagesRequest) returns (stream ReportAppPackagesResponse);

  // `Gebura` `Normal`
  rpc AddAppPackageRunTime(AddAppPackageRunTimeRequest) returns (AddAppPackageRunTimeResponse);
  // `Gebura` `Normal` Only support AGGREGATION_TYPE_OVERALL
  rpc SumAppPackageRunTime(SumAppPackageRunTimeRequest) returns (SumAppPackageRunTimeResponse);

  // `Gebura` `Normal`
  rpc UploadGameSaveFile(UploadGameSaveFileRequest) returns (UploadGameSaveFileResponse);
  // `Gebura` `Normal`
  rpc DownloadGameSaveFile(DownloadGameSaveFileRequest) returns (DownloadGameSaveFileResponse);
  // `Gebura` `Normal`
  rpc ListGameSaveFiles(ListGameSaveFilesRequest) returns (ListGameSaveFilesResponse);
  // `Gebura` `Normal`
  rpc RemoveGameSaveFile(RemoveGameSaveFileRequest) returns (RemoveGameSaveFileResponse);
  // `Gebura` `Normal`
  rpc PinGameSaveFile(PinGameSaveFileRequest) returns (PinGameSaveFileResponse);
  // `Gebura` `Normal`
  rpc UnpinGameSaveFile(UnpinGameSaveFileRequest) returns (UnpinGameSaveFileResponse);

  // `Gebura` `Admin`
  rpc SetUserSaveFileCapacity(SetUserSaveFileCapacityRequest) returns (SetUserSaveFileCapacityResponse);
  // `Gebura` `Normal`
  rpc SetSaveFileRotation(SetSaveFileRotationRequest) returns (SetSaveFileRotationResponse);

  // `Gebura` `Normal`
  rpc ListAppCategories(ListAppCategoriesRequest) returns (ListAppCategoriesResponse);
  // `Gebura` `Normal`
  rpc CreateAppCategory(CreateAppCategoryRequest) returns (CreateAppCategoryResponse);
  // `Gebura` `Normal`
  rpc UpdateAppCategory(UpdateAppCategoryRequest) returns (UpdateAppCategoryResponse);
  // `Gebura` `Normal`
  rpc RemoveAppCategory(RemoveAppCategoryRequest) returns (RemoveAppCategoryResponse);

  // `Netzach` `Normal`
  rpc CreateNotifyTarget(CreateNotifyTargetRequest) returns (CreateNotifyTargetResponse);
  // `Netzach` `Normal`
  rpc UpdateNotifyTarget(UpdateNotifyTargetRequest) returns (UpdateNotifyTargetResponse);
  // `Netzach` `Normal`
  rpc ListNotifyTargets(ListNotifyTargetsRequest) returns (ListNotifyTargetsResponse);
  // `Netzach` `Normal`
  rpc CreateNotifyFlow(CreateNotifyFlowRequest) returns (CreateNotifyFlowResponse);
  // `Netzach` `Normal`
  rpc UpdateNotifyFlow(UpdateNotifyFlowRequest) returns (UpdateNotifyFlowResponse);
  // `Netzach` `Normal`
  rpc ListNotifyFlows(ListNotifyFlowsRequest) returns (ListNotifyFlowsResponse);

  // `Yesod` `Normal`
  rpc CreateFeedConfig(CreateFeedConfigRequest) returns (CreateFeedConfigResponse);
  // `Yesod` `Normal`
  rpc UpdateFeedConfig(UpdateFeedConfigRequest) returns (UpdateFeedConfigResponse);
  // `Yesod` `Normal`
  rpc ListFeedConfigs(ListFeedConfigsRequest) returns (ListFeedConfigsResponse);

  // `Yesod` `Normal`
  rpc ListFeedCategories(ListFeedCategoriesRequest) returns (ListFeedCategoriesResponse);
  // `Yesod` `Normal`
  rpc ListFeedPlatforms(ListFeedPlatformsRequest) returns (ListFeedPlatformsResponse);
  // `Yesod` `Normal`
  rpc ListFeedItems(ListFeedItemsRequest) returns (ListFeedItemsResponse);
  // `Yesod` `Normal`
  rpc GroupFeedItems(GroupFeedItemsRequest) returns (GroupFeedItemsResponse);
  // `Yesod` `Normal`
  rpc GetFeedItem(GetFeedItemRequest) returns (GetFeedItemResponse);
  // `Yesod` `Normal`
  rpc GetBatchFeedItems(GetBatchFeedItemsRequest) returns (GetBatchFeedItemsResponse);
  // `Yesod` `Normal`
  rpc ReadFeedItem(ReadFeedItemRequest) returns (ReadFeedItemResponse);

  // `Yesod` `Normal`
  rpc CreateFeedItemCollection(CreateFeedItemCollectionRequest) returns (CreateFeedItemCollectionResponse);
  // `Yesod` `Normal`
  rpc UpdateFeedItemCollection(UpdateFeedItemCollectionRequest) returns (UpdateFeedItemCollectionResponse);
  // `Yesod` `Normal`
  rpc ListFeedItemCollections(ListFeedItemCollectionsRequest) returns (ListFeedItemCollectionsResponse);
  // `Yesod` `Normal`
  rpc AddFeedItemToCollection(AddFeedItemToCollectionRequest) returns (AddFeedItemToCollectionResponse);
  // `Yesod` `Normal`
  rpc RemoveFeedItemFromCollection(RemoveFeedItemFromCollectionRequest) returns (RemoveFeedItemFromCollectionResponse);
  // `Yesod` `Normal`
  rpc ListCollectionItems(ListCollectionItemsRequest) returns (ListCollectionItemsResponse);
}

message GetServerInformationRequest {}
message GetServerInformationResponse {
  // For manual inspection only, the client may display but should not parse the response.
  ServerBinarySummary server_binary_summary = 1;
  // For manual inspection only, the client may display but should not parse the response.
  ServerProtocolSummary protocol_summary = 2;
  // The time that server received the request,
  // note that there is a transmission delay between server and client.
  google.protobuf.Timestamp current_time = 3;
  // Valid when accessToken is provided.
  optional ServerFeatureSummary feature_summary = 4;
}

message ServerBinarySummary {
  // Server source code address.
  // *Should* be a valid http address.
  string source_code_address = 1;
  // Binary build version.
  // The content *should* be a semantic version string similar to the one generated by `git describe`,
  // but rely on the actual implementation of the server.
  string build_version = 2;
  // Binary build date.
  // The content *should* be a date format that is human-readable.
  string build_date = 3;
}

message ServerProtocolSummary {
  // Protocol version used by server.
  // The content *must* be a semantic version string generated by `git describe`,
  // and if the server is built for production, it *must* be a valid version tag.
  string version = 1;
}

message ServerFeatureSummary {
  repeated string supported_account_platforms = 1;
  repeated string supported_app_sources = 2;
  repeated string supported_feed_sources = 3;
  repeated string supported_notify_destinations = 4;
}
